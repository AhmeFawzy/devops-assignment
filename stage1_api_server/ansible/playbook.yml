---
- name: Deploy Flask API Server
  hosts: webservers
  become: yes
  tasks:

    - name: Ensure Python3 and pip are installed
      apt:
        name:
          - python3
          - python3-pip
        state: present
        update_cache: yes

    - name: Create application directory
      file:
        path: /home/ahmed/app
        state: directory
        owner: ahmed
        group: ahmed
        mode: '0755'

    - name: Copy application files
      copy:
        src: ../app/
        dest: /home/ahmed/app/
        owner: ahmed
        group: ahmed
        mode: '0755'

    - name: Install required Python packages
      pip:
        requirements: /home/ahmed/app/requirements.txt
        executable: pip3

    - name: Start Flask application
      shell: |
        nohup python3 /home/ahmed/app/server.py > /home/ahmed/app/server.log 2>&1 &
      args:
        chdir: /home/ahmed/app/
